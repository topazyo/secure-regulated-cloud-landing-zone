{
  "criticalControls": [
    {
      "id": "NET_NSG_DEFAULT_DENY",
      "category": "NetworkSecurity",
      "description": "Ensure default NSG rules include a deny-all for inbound traffic.",
      "controlType": "NSGConfig",
      "targetScope": "AllNSGs",
      "expectedConfiguration": {
        "defaultInboundRule": {
          "access": "Deny",
          "protocol": "*",
          "direction": "Inbound",
          "priorityRange": "4000-4096"
        }
      }
    },
    {
      "id": "NET_NSG_NO_ANY_ALLOW",
      "category": "NetworkSecurity",
      "description": "Verify no NSG rules allow 'Any' or 'Internet' source for critical ports without justification.",
      "controlType": "NSGRuleCheck",
      "targetScope": "AllNSGs",
      "ruleCriteria": {
        "access": "Allow",
        "sourceAddressPrefixes": ["Any", "Internet", "0.0.0.0/0", "::/0"],
        "destinationPortRange": ["22", "3389", "1433", "3306"]
      },
      "expectedResult": "NotExists"
    },
    {
      "id": "NET_NSG_SUBNET_ATTACHMENT",
      "category": "NetworkSecurity",
      "description": "Ensure all subnets have an NSG attached.",
      "controlType": "SubnetConfig",
      "targetScope": "AllSubnets",
      "expectedConfiguration": {
        "nsgAttached": true
      }
    },
    {
      "id": "ENC_KV_SKU_PREMIUM",
      "category": "Encryption",
      "description": "Azure Key Vault SKU must be 'Premium' for HSM-backed keys.",
      "controlType": "KeyVaultProperties",
      "targetScope": "AllKeyVaults",
      "expectedConfiguration": {
        "sku": "Premium"
      }
    },
    {
      "id": "ENC_KV_SOFT_DELETE",
      "category": "Encryption",
      "description": "Azure Key Vault must have soft delete enabled.",
      "controlType": "KeyVaultProperties",
      "targetScope": "AllKeyVaults",
      "expectedConfiguration": {
        "enableSoftDelete": true
      }
    },
    {
      "id": "ENC_KV_PURGE_PROTECTION",
      "category": "Encryption",
      "description": "Azure Key Vault must have purge protection enabled.",
      "controlType": "KeyVaultProperties",
      "targetScope": "AllKeyVaults",
      "expectedConfiguration": {
        "enablePurgeProtection": true
      }
    },
    {
      "id": "ENC_KV_KEY_EXPIRATION",
      "category": "Encryption",
      "description": "HSM Keys in Key Vault should have an expiration date set (e.g., within 1 year).",
      "controlType": "KeyVaultKeyProperties",
      "targetScope": "AllHSMKeys",
      "expectedConfiguration": {
        "attributes": {
          "expires": true,
          "maxValidityDays": 365
        }
      }
    },
    {
      "id": "ENC_STORAGE_ENCRYPTION_CMK",
      "category": "Encryption",
      "description": "Storage accounts must use Customer-Managed Keys (CMK) from Key Vault for encryption.",
      "controlType": "StorageAccountProperties",
      "targetScope": "AllStorageAccounts",
      "expectedConfiguration": {
        "encryption": {
          "services": {
            "blob": {"keyType": "Account"},
            "file": {"keyType": "Account"}
          },
          "keySource": "Microsoft.Keyvault"
        }
      }
    },
    {
      "id": "IAM_LIMIT_OWNER_ROLES",
      "category": "IdentityAndAccess",
      "description": "Limit the number of Owner role assignments on subscriptions (e.g., max 3).",
      "controlType": "RBACCheck",
      "targetScope": "Subscription",
      "roleDefinitionId": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635", // Owner Role ID
      "maxAssignments": 3
    },
    {
      "id": "IAM_NO_WILDCARD_CUSTOM_ROLES",
      "category": "IdentityAndAccess",
      "description": "Ensure no custom IAM roles grant wildcard permissions (e.g., */*).",
      "controlType": "CustomRoleCheck",
      "targetScope": "AllCustomRoles",
      "prohibitedPermissions": ["*/*"]
    },
    {
      "id": "LOG_KV_DIAGNOSTICS",
      "category": "LoggingAndMonitoring",
      "description": "Key Vault diagnostic settings must be enabled, capturing at least AuditEvent.",
      "controlType": "DiagnosticSettings",
      "targetResourceType": "Microsoft.KeyVault/vaults",
      "requiredLogs": ["AuditEvent"],
      "requiredMetrics": [],
      "minRetentionDays": 90
    },
    {
      "id": "LOG_NSG_FLOWLOGS",
      "category": "LoggingAndMonitoring",
      "description": "NSG flow logs must be enabled and retained for at least 90 days.",
      "controlType": "NSGFlowLogs",
      "targetScope": "AllNSGs",
      "expectedConfiguration": {
        "enabled": true,
        "retentionPolicy": {
          "enabled": true,
          "days": ">=90"
        }
      }
    },
    {
      "id": "LOG_ACTIVITY_LOG_RETENTION",
      "category": "LoggingAndMonitoring",
      "description": "Azure Activity Log must be retained for at least 365 days.",
      "controlType": "ActivityLogAlerts", // Actually diagnostic settings for subscription
      "targetScope": "Subscription",
       "expectedConfiguration": {
        "storageAccountId": "NotNull", // Or specific LA workspace
        "retentionPolicy": {
          "enabled": true,
          "days": ">=365"
        },
        "categories": ["Administrative", "Security", "ServiceHealth", "Alert", "Recommendation", "Policy", "Autoscale"]
      }
    },
    {
      "id": "LOG_LA_WORKSPACE_RETENTION",
      "category": "LoggingAndMonitoring",
      "description": "Default Log Analytics workspace retention should be >= 365 days.",
      "controlType": "LogAnalyticsWorkspace",
      "targetScope": "DefaultWorkspace", // Or all workspaces
      "expectedConfiguration": {
        "retentionInDays": ">=365"
      }
    },
    {
      "id": "LOG_SENTINEL_ENABLED",
      "category": "LoggingAndMonitoring",
      "description": "Microsoft Sentinel (or Azure Security Insights) should be enabled on the primary Log Analytics workspace.",
      "controlType": "SentinelCheck",
      "targetScope": "PrimaryLogAnalyticsWorkspace",
      "expectedConfiguration": {
        "enabled": true
      }
    },
    {
      "id": "PCI_NET_SEGMENTATION_CDE",
      "category": "Regulatory_PCI-DSS",
      "controlReference": "PCI-DSS Req 1.2, 1.3",
      "description": "Network segmentation for Cardholder Data Environment (CDE) subnets must be enforced via NSGs, restricting traffic to only what is necessary.",
      "controlType": "SubnetCompliance", // This would link to network_requirements.json
      "targetScopePatterns": ["pci-zone-.*"],
      "complianceProfile": "pci-dss" // Points to a profile in network_requirements.json
    },
    {
      "id": "PCI_ENC_CHD_AT_REST",
      "category": "Regulatory_PCI-DSS",
      "controlReference": "PCI-DSS Req 3.4",
      "description": "Cardholder Data (CHD) must be encrypted at rest using strong cryptography (e.g., AES-256 via CMK in Key Vault).",
      "controlType": "MultiCheck",
      "checks": [
        {"controlId": "ENC_STORAGE_ENCRYPTION_CMK", "targetScope": "StorageAccountsWithCHD"},
        {"controlId": "ENC_KV_SKU_PREMIUM", "targetScope": "KeyVaultsForCHD"}
      ]
    },
    {
      "id": "PCI_LOG_AUDIT_TRAILS",
      "category": "Regulatory_PCI-DSS",
      "controlReference": "PCI-DSS Req 10.1, 10.2, 10.3",
      "description": "Audit logs for all CDE system components must be enabled, collected, and retained.",
      "controlType": "MultiCheck",
      "checks": [
        {"controlId": "LOG_KV_DIAGNOSTICS", "targetScope": "KeyVaultsForCHD"},
        {"controlId": "LOG_NSG_FLOWLOGS", "targetScope": "NSGsForCDE"},
        {"controlId": "LOG_ACTIVITY_LOG_RETENTION"}
      ]
    }
  ]
}
